apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: monitoring
  labels:
    app: grafana
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
    - name: 'default'
      orgId: 1
      folder: ''
      type: file
      disableDeletion: false
      updateIntervalSeconds: 10
      allowUiUpdates: true
      options:
        path: /var/lib/grafana/dashboards
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-files
  namespace: monitoring
  labels:
    app: grafana
data:
  n8n-overview.json: |
    {
      "dashboard": {
        "id": null,
        "title": "n8n Cluster Overview",
        "tags": ["n8n", "automation"],
        "style": "dark",
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "n8n Workflow Executions",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(n8n_workflow_executions_total[5m])",
                "legendFormat": "Executions/sec"
              }
            ],
            "yAxes": [
              {
                "label": "Executions/sec"
              }
            ],
            "xAxes": [
              {
                "type": "time"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 0
            }
          },
          {
            "id": 2,
            "title": "n8n Pod Status",
            "type": "stat",
            "targets": [
              {
                "expr": "up{job=\"n8n-cluster\"}",
                "legendFormat": "Pods Up"
              }
            ],
            "gridPos": {
              "h": 4,
              "w": 6,
              "x": 12,
              "y": 0
            }
          },
          {
            "id": 3,
            "title": "n8n CPU Usage",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(container_cpu_usage_seconds_total{pod=~\"n8n.*\"}[5m]) * 100",
                "legendFormat": "CPU %"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 8
            }
          },
          {
            "id": 4,
            "title": "n8n Memory Usage",
            "type": "graph",
            "targets": [
              {
                "expr": "container_memory_usage_bytes{pod=~\"n8n.*\"} / 1024 / 1024",
                "legendFormat": "Memory MB"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 8
            }
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "30s"
      }
    }
  metabase-overview.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Metabase Cluster Overview",
        "tags": ["metabase", "analytics"],
        "style": "dark",
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Metabase Requests",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(http_requests_total{job=\"metabase-cluster\"}[5m])",
                "legendFormat": "Requests/sec"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 0
            }
          },
          {
            "id": 2,
            "title": "Metabase Pod Status",
            "type": "stat",
            "targets": [
              {
                "expr": "up{job=\"metabase-cluster\"}",
                "legendFormat": "Pods Up"
              }
            ],
            "gridPos": {
              "h": 4,
              "w": 6,
              "x": 12,
              "y": 0
            }
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "30s"
      }
    }
  infrastructure-overview.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Infrastructure Overview",
        "tags": ["infrastructure", "kubernetes"],
        "style": "dark",
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Cluster CPU Usage",
            "type": "graph",
            "targets": [
              {
                "expr": "100 - (avg(rate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)",
                "legendFormat": "CPU Usage %"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 0
            }
          },
          {
            "id": 2,
            "title": "Cluster Memory Usage",
            "type": "graph",
            "targets": [
              {
                "expr": "(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100",
                "legendFormat": "Memory Usage %"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 0
            }
          },
          {
            "id": 3,
            "title": "Pod Count by Namespace",
            "type": "piechart",
            "targets": [
              {
                "expr": "count by (namespace) (kube_pod_info)",
                "legendFormat": "{{namespace}}"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 8
            }
          },
          {
            "id": 4,
            "title": "Node Status",
            "type": "stat",
            "targets": [
              {
                "expr": "kube_node_status_condition{condition=\"Ready\"}",
                "legendFormat": "Ready Nodes"
              }
            ],
            "gridPos": {
              "h": 4,
              "w": 6,
              "x": 12,
              "y": 8
            }
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "30s"
      }
    }
